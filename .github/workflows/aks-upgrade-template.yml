name: AKS Cluster Upgrade Template

on:
  workflow_call:
    inputs:
      environment:
        description: "Cluster environment"
        type: string
        required: true
      resource_group:
        description: "AKS cluster resource group"
        type: string
        required: true
      cluster_name:
        description: "AKS cluster name"
        type: string
        required: true
      kubernetes_version:
        description: "Version to upgrade cluster to"
        type: string
        required: true
    secrets:
      azure_credentials:
        required: true

jobs:
  upgrade-control-plane:
    name: Upgrade ${{ inputs.environment }} Control Plan
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - name: Azure login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.azure_credentials }}

      - name: AKS control-plane upgrade
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az aks upgrade --resource-group ${{ inputs.resource_group }} 
                           --name ${{ inputs.cluste_name }} 
                           --kubernetes-version ${{ inputs.kubernetes_version}}
                           --control-plane-only
                           --yes

  upgrade-nodes:
    name: Upgrade ${{ inputs.environment }} Nodes
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    needs: upgrade-control-plane
    steps:
      - name: Azure login
        uses: azure/login@v1.4.3
        with:
          creds: ${{ secrets.azure_credentials }}

      - name: AKS control-plane upgrade
        uses: azure/cli@v1.0.6
        with:
          inlineScript: |
            az aks upgrade --resource-group ${{ inputs.resource-group }} 
                           --name ${{ inputs.cluster-name }} 
                           --kubernetes-version ${{ inputs.kubernetes-version}}
                           --upgrade-control-plane
                           --yes
